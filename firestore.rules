
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Allow public read access to produce listings
    match /produce/{produceId} {
      allow read: if true;
      allow write: if request.auth != null; // Logged-in users can create/update
    }

    // Allow public read for loan providers
    match /LoanProviders/{providerId} {
        allow read: if true;
        allow write: if false; // Should be managed by an admin
    }

    // Farmers can create loan applications for themselves
    match /LoanApplications/{applicationId} {
        allow read: if request.auth.uid == resource.data.farmer_id;
        allow create: if request.auth.uid == request.resource.data.farmer_id && request.resource.data.status == 'Pending';
        // Providers (or admins) can update the status
        allow update: if get(/databases/$(database)/documents/Users/$(request.auth.uid)).data.role == 'provider';
    }

    // Users can read their own data
    match /Users/{userId} {
        allow read, write: if request.auth.uid == userId;
    }

    // Transactions can be created by logged-in users, and read by the relevant farmer
    match /Transactions/{transactionId} {
        allow create: if request.auth != null;
        allow read: if request.auth.uid == resource.data.farmer_id;
    }
  }
}
